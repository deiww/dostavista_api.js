/*! dostavista_api.js v0.10 | (c) 2014 Dostavista.ru, <api@dostavista.ru> | https://github.com/dostavista/dostavista_api.js */!function(a,b,c){var d,e=!0,f=5e3,g="https://robotapitest.dostavista.ru/bapi/order",h=g,i={onBeforeSend:null,onSendSuccess:null,onSendError:null,onError:null},j={},k={20:"Уже откликнулся на заказ",22:"Аукцион завершен, поздно делать ставки",23:"Невозможно отозвать ставку: ее нет",24:"Слишком большая ставка",64:"Неизвестная ошибка",128:"Попытка вызова API несуществующей версии",1024:"Неверный метод запроса (GET/POST)",2048:"Некорректные данные запроса",4096:"Неверный токен или идентификатор клиента",8192:"На точке указан телефон зарегистрированного клиента. Для продолжения требуется авторизоваться",8193:"Тип доставки не соответствует суммарному весу заказа",8194:"Сумма выкупа по активным заказам слишком велика"},l=function(a){var b=function(a){alert("dostavista_api.js: "+a)};if(!e)if(console)try{console.error(a)}catch(c){b(a)}else b(a)};if("function"!=typeof c)return void l("Для работы необходим jQuery версии 1.8 и старше.");var m=function(a){h=a},n=function(a){j.client_id=a.client_id||!1,j.token=a.token||!1},o=function(a){e=!a},p=function(a,b){return a&&b?i.hasOwnProperty(a)?"function"!=typeof b?(l("Второй аргумент должен быть функцией."),!1):(i[a]=b,!0):(l("Недопустимый тип колбэка."),!1):(l("Недостаточно параметров."),!1)},q=function(a){a.preventDefault();var b=this,c=function(){var a=t.call(b);try{v(a)}catch(c){return l(c),void w.call(b,"error",c)}var d=function(a,c,d,e){"function"==typeof i.onSendError?i.onSendError(a,c,d):l(e),w.call(b,"error",e)},e=s(a);e.done(function(a){if(a.error_code){for(var c=[],e=0,f=a.error_code.length;f>e;e++)c.push(a.error_code[e]+": "+k[a.error_code[e]]);return void d(null,null,null,c.join("\n"))}"function"==typeof i.onSendSuccess&&i.onSendSuccess(a,b),w.call(b,"sent","ID заказа в Достависте: "+a.order_id)}),e.fail(function(a,b,c){d(a,b,c,"Ошибка отправки на "+h)})};if(!y.call(b))return void(z.call(b)&&w.call(b));if(!j.client_id||!j.token)return void l("Установите clientId и token сразу после подключения плагина.");if(w.call(b,"sending"),"function"==typeof i.onBeforeSend){var d=i.onBeforeSend.call(b);if("object"==typeof d&&"function"==typeof d.done&&"function"==typeof d.fail)return void d.always(function(){c()});l("onBeforeSend-колбэк должен возвращать $.Deferred().promise().")}c()},r=function(a){a.preventDefault();var b=this,d=c(b).closest(".DostavistaCombo"),e=c(".DostavistaComboCheckbox:checked",d),f=function(){var a=u(e);try{v(a)}catch(c){return l(c),x.call(b,"error",c),void("function"==typeof i.onError&&i.onError(c,e))}var d=function(a,c,d,e){"function"==typeof i.onSendError?i.onSendError(a,c,d):l(e),x.call(b,"error",e)},f=s(a);f.done(function(a){if(a.error_code){for(var c=[],f=0,g=a.error_code.length;g>f;f++)c.push(a.error_code[f]+": "+k[a.error_code[f]]);return void d(null,null,null,c.join("\n"))}"function"==typeof i.onSendSuccess&&i.onSendSuccess(a,e),x.call(b,"sent","ID заказа в Достависте: "+a.order_id),e.attr("disabled","disabled").removeProp("checked")}),f.fail(function(a,b,c){d(a,b,c,"Ошибка отправки на "+h)})};if(!y.call(b))return void(z.call(b)&&x.call(b));if(!j.client_id||!j.token)return void l("Установите clientId и token сразу после подключения плагина.");if(x.call(b,"sending"),"function"==typeof i.onBeforeSend){var g=i.onBeforeSend.call(b);if("object"==typeof g&&"function"==typeof g.done&&"function"==typeof g.fail)return void g.always(function(){f()});l("onBeforeSend-колбэк должен возвращать $.Deferred().promise().")}f()},s=function(a){var b=c.Deferred();a=c.extend(a,j);var e={data:a,url:g,type:"post",dataType:"jsonp",cache:!1},h=function(a){b.resolve(a)},i=function(a,c,d){b.reject(a,c,d)},k=function(){clearTimeout(d)},l=c.ajax(e).done(h).fail(i).always(k);return d=setTimeout(function(){l.abort(),b.reject(null,"Ответа нет слишком долго. Возможно, проблемы с сетью.",null)},f),b.promise()},t=function(){var a=function(a){return Number(a)},b=function(a){return a=a.replace(/[^\d]/g,""),a=a.substr(a.length-10,a.length)},d=function(a,b){for(var d={},e=null,f=0,g=a.length;g>f;f++){if(e=c(b).attr(a[f].name),!e&&"required"in a[f])return null;e&&(d[a[f].name.replace(/dsta-(\w*\d{1}_)?/,"")]=a[f].parse?a[f].parse(e):e)}return d},e=[{name:"dsta-matter"},{name:"dsta-insurance",parse:a}],f={point:[{}]};f=c.extend(f,d(e,this));for(var g=0;10>g;g++){var h="dsta-point"+g+"_",i=d([{name:h+"address",required:!0},{name:h+"client_order_id"},{name:h+"taking",parse:a},{name:h+"weight",parse:a},{name:h+"phone",parse:b},{name:h+"contact_person"},{name:h+"required_time"},{name:h+"required_time_start"}],this);if(!i)break;f.point[g]=i}return f},u=function(a){var b={matter:null,insurance:0,point:[]};return a.each(function(a,d){var e=t.call(d);b.matter||(b.matter=e.matter),e.insurance&&(b.insurance+=e.insurance),"point"in e&&e.point.length&&(b.point.length&&e.point[0].address==b.point[0].address&&("weight"in e.point[0]&&(b.point[0].weight+=e.point[0].weight),e.point.shift()),c.merge(b.point,e.point))}),b},v=function(a){var b=/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/,c="";a.matter||(c+="Не задан параметр matter.\n");for(var d=0,e=a.point.length;e>d;d++)a.point[d].address||(c+="Не задан параметр point["+d+"].address.\n"),a.point[d].phone&&10===a.point[d].phone.length||(c+="Параметр point["+d+"].phone должен состоять из 10 цифр.\n"),b.test(a.point[d].required_time_start)||(c+="Параметр point["+d+"].required_time_start должен быть в формате YYYY-MM-DD HH:MM:SS.\n"),b.test(a.point[d].required_time)||(c+="Параметр point["+d+"].required_time должен быть в формате YYYY-MM-DD HH:MM:SS.\n"),a.point[d].weight||(c+="Не задан параметр point["+d+"].weight.\n");if(c)throw c},w=function(a,b){a=a||!1,c(this).removeClass(),c(this).addClass("DostavistaButton"),a&&(c(this).addClass("DostavistaButton_"+a),c.inArray(a,["sending","sent","error"])>-1&&c(this).addClass("DostavistaButton_disabled")),c(this).removeAttr("title"),b&&c(this).attr("title",b)},x=function(a,b){a=a||!1,c(this).removeClass(),c(this).addClass("DostavistaComboSubmit"),a&&(c(this).addClass("DostavistaComboSubmit_"+a),c.inArray(a,["sending","sent","error"])>-1&&c(this).addClass("DostavistaButton_disabled")),c(this).removeAttr("title"),b&&c(this).attr("title",b)},y=function(){return!(c(this).hasClass("DostavistaButton_disabled")||c(this).hasClass("DostavistaButton_sent"))},z=function(){return c(this).hasClass("DostavistaButton_error")};c(b).on("click",".DostavistaButton",q),c(b).on("click",".DostavistaCombo .DostavistaComboSubmit",r),c(b).on("click",".DostavistaCombo .DostavistaComboCheckbox",function(){var a=c(this).closest(".DostavistaCombo").find(".DostavistaComboSubmit");x.call(a)}),a.DostavistaApi={setApiUrl:m,setClient:n,setCallback:p,setDebug:o}}(window,document,jQuery);