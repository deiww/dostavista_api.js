/*! dostavista_api.js v0.9 | (c) 2014 Dostavista.ru, Oleg Gromov <mail@oleggromov.com> | https://github.com/dostavista/dostavista_api.js */!function(a,b,c,d){var e=!1,f=5e3,g=d?"http://beta.dostavista.ru/bapi/order":"http://dostavista.ru/bapi/order",h={onBeforeSend:null,onSendSuccess:null,onSendError:null},i={},j=function(a){var b=function(a){alert("dostavista_api.js: "+a)};if(!e)if(console)try{console.error(a)}catch(c){b(a)}else b(a)};if("function"!=typeof c)return void j("Для работы необходим jQuery версии 1.8 и старше.");var k=function(a){i.client_id=a.client_id||!1,i.token=a.token||!1},l=function(a,b){return a&&b?h.hasOwnProperty(a)?"function"!=typeof b?(j("Второй аргумент должен быть функцией."),!1):(h[a]=b,!0):(j("Недопустимый тип колбэка."),!1):(j("Недостаточно параметров."),!1)},m=function(a){a.preventDefault();var b=this,c=function(){var a=o.call(b);try{p(a)}catch(c){return j(c),void q.call(b,"error",c)}var d=n(a);d.done(function(a){"function"==typeof h.onSendSuccess&&h.onSendSuccess(a),q.call(b,"sent","ID заказа в Достависте: "+a.order_id)}),d.fail(function(a,c,d){"function"==typeof h.onSendError?h.onSendError(a,c,d):j("Ошибка отправки на "+g),q.call(b,"error","Ошибка отправки на "+g)})};if(!r.call(b))return void(s.call(b)&&q.call(b));if(!i.client_id||!i.token)return void j("Установите clientId и token сразу после подключения плагина.");if(q.call(b,"sending"),"function"==typeof h.onBeforeSend){var d=h.onBeforeSend.call(b);if("object"==typeof d&&"function"==typeof d.done&&"function"==typeof d.fail)return void d.always(function(){c()});j("onBeforeSend-колбэк должен возвращать $.Deferred().promise().")}c()},n=function(a){var b=c.Deferred();a=c.extend(a,i);var d={data:a,url:g,type:"post",dataType:"jsonp",cache:!1},e=function(a){b.resolve(a)},h=function(a,c,d){b.reject(a,c,d)},j=c.ajax(d).done(e).fail(h);return setTimeout(function(){j.abort(),b.reject(null,"Ответа нет слишком долго. Возможно, проблемы с сетью.",null)},f),b.promise()},o=function(){var a=function(a){return Number(a)},b=function(a){return a=a.replace(/[^\d]/g,""),a=a.substr(a.length-10,a.length)},d=function(a,b){for(var d={},e=null,f=0,g=a.length;g>f;f++)e=c(b).attr(a[f].name),e&&(d[a[f].name.replace(/dsta-(\w*\d{1}_)?/,"")]=a[f].parse?a[f].parse(e):e);return d},e=[{name:"dsta-matter"},{name:"dsta-insurance",parse:a}],f=[{name:"dsta-point0_client_order_id"},{name:"dsta-point0_taking",parse:a},{name:"dsta-point0_weight",parse:a},{name:"dsta-point0_phone",parse:b},{name:"dsta-point0_contact_person"},{name:"dsta-point0_required_time"},{name:"dsta-point0_required_time_start"},{name:"dsta-point0_address"}],g=[{name:"dsta-point1_taking",parse:a},{name:"dsta-point1_weight",parse:a},{name:"dsta-point1_phone",parse:b},{name:"dsta-point1_contact_person"},{name:"dsta-point1_required_time"},{name:"dsta-point1_required_time_start"},{name:"dsta-point1_address"}],h={point:[{}]};return h=c.extend(h,d(e,this)),h.point[0]=d(f,this),h.point[1]=d(g,this),h},p=function(a){var b=/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/,c="";a.matter||(c+="Не задан параметр matter.\n");for(var d=0,e=a.point.length;e>d;d++)a.point[d].address||(c+="Не задан параметр point["+d+"].address.\n"),a.point[d].phone&&10===a.point[d].phone.length||(c+="Параметр point["+d+"].phone должен состоять из 10 цифр.\n"),b.test(a.point[d].required_time_start)||(c+="Параметр point["+d+"].time_start должен быть в формате YYYY-MM-DD HH:MM:SS.\n"),b.test(a.point[d].required_time)||(c+="Параметр point["+d+"].time должен быть в формате YYYY-MM-DD HH:MM:SS.\n"),a.point[d].weight||(c+="Не задан параметр point["+d+"].weight.\n");if(c)throw c},q=function(a,b){a=a||!1,c(this).removeClass(),c(this).addClass("DostavistaButton"),a&&(c(this).addClass("DostavistaButton_"+a),c.inArray(a,["sending","sent","error"])>-1&&c(this).addClass("DostavistaButton_disabled")),c(this).removeAttr("title"),b&&c(this).attr("title",b)},r=function(){return!c(this).hasClass("DostavistaButton_disabled")},s=function(){return c(this).hasClass("DostavistaButton_error")};c(b).on("click",".DostavistaButton",m),a.DostavistaApi={setClient:k,setCallback:l}}(window,document,jQuery,!0);