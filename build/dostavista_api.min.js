/*! dostavista_api.js v0.9 | (c) 2014 Dostavista.ru, Oleg Gromov <mail@oleggromov.com> | https://github.com/dostavista/dostavista_api.js */!function(a,b,c){var d,e=!0,f=5e3,g="http://bapi.dostavista.ru/bapi/order",h="http://beta.dostavista.ru/bapi/order",i=!1,j={onBeforeSend:null,onSendSuccess:null,onSendError:null,onError:null},k={},l={20:"Уже откликнулся на заказ",22:"Аукцион завершен, поздно делать ставки",23:"Невозможно отозвать ставку: ее нет",24:"Слишком большая ставка",64:"Неизвестная ошибка",128:"Попытка вызова API несуществующей версии",1024:"Неверный метод запроса (GET/POST)",2048:"Неверный идентификатор клиента",4096:"Неверный токен доступа"},m=function(a){var b=function(a){alert("dostavista_api.js: "+a)};if(!e)if(console)try{console.error(a)}catch(c){b(a)}else b(a)};if("function"!=typeof c)return void m("Для работы необходим jQuery версии 1.8 и старше.");var n=function(a){g=a},o=function(a){k.client_id=a.client_id||!1,k.token=a.token||!1},p=function(a){i=a},q=function(a){e=!a},r=function(a,b){return a&&b?j.hasOwnProperty(a)?"function"!=typeof b?(m("Второй аргумент должен быть функцией."),!1):(j[a]=b,!0):(m("Недопустимый тип колбэка."),!1):(m("Недостаточно параметров."),!1)},s=function(a){a.preventDefault();var b=this,c=function(){var a=v.call(b);try{x(a)}catch(c){return m(c),void y.call(b,"error",c)}var d=function(a,c,d,e){"function"==typeof j.onSendError?j.onSendError(a,c,d):m(e),y.call(b,"error",e)},e=u(a);e.done(function(a){if(a.error_code){for(var c=[],e=0,f=a.error_code.length;f>e;e++)c.push(a.error_code[e]+": "+l[a.error_code[e]]);return void d(null,null,null,c.join("\n"))}"function"==typeof j.onSendSuccess&&j.onSendSuccess(a,b),y.call(b,"sent","ID заказа в Достависте: "+a.order_id)}),e.fail(function(a,b,c){d(a,b,c,"Ошибка отправки на "+g)})};if(!A.call(b))return void(B.call(b)&&y.call(b));if(!k.client_id||!k.token)return void m("Установите clientId и token сразу после подключения плагина.");if(y.call(b,"sending"),"function"==typeof j.onBeforeSend){var d=j.onBeforeSend.call(b);if("object"==typeof d&&"function"==typeof d.done&&"function"==typeof d.fail)return void d.always(function(){c()});m("onBeforeSend-колбэк должен возвращать $.Deferred().promise().")}c()},t=function(a){a.preventDefault();var b=this,d=c(b).closest(".DostavistaCombo"),e=c(".DostavistaComboCheckbox:checked",d),f=function(){var a=w(e);try{x(a)}catch(c){return m(c),z.call(b,"error",c),void("function"==typeof j.onError&&j.onError(c,e))}var d=function(a,c,d,e){"function"==typeof j.onSendError?j.onSendError(a,c,d):m(e),z.call(b,"error",e)},f=u(a);f.done(function(a){if(a.error_code){for(var c=[],f=0,g=a.error_code.length;g>f;f++)c.push(a.error_code[f]+": "+l[a.error_code[f]]);return void d(null,null,null,c.join("\n"))}"function"==typeof j.onSendSuccess&&j.onSendSuccess(a,e),z.call(b,"sent","ID заказа в Достависте: "+a.order_id),e.attr("disabled","disabled").removeProp("checked")}),f.fail(function(a,b,c){d(a,b,c,"Ошибка отправки на "+g)})};if(!A.call(b))return void(B.call(b)&&z.call(b));if(!k.client_id||!k.token)return void m("Установите clientId и token сразу после подключения плагина.");if(z.call(b,"sending"),"function"==typeof j.onBeforeSend){var h=j.onBeforeSend.call(b);if("object"==typeof h&&"function"==typeof h.done&&"function"==typeof h.fail)return void h.always(function(){f()});m("onBeforeSend-колбэк должен возвращать $.Deferred().promise().")}f()},u=function(a){var b=c.Deferred();a=c.extend(a,k);var e={data:a,url:i?h:g,type:"post",dataType:"jsonp",cache:!1},j=function(a){b.resolve(a)},l=function(a,c,d){b.reject(a,c,d)},m=function(){clearTimeout(d)},n=c.ajax(e).done(j).fail(l).always(m);return d=setTimeout(function(){n.abort(),b.reject(null,"Ответа нет слишком долго. Возможно, проблемы с сетью.",null)},f),b.promise()},v=function(){var a=function(a){return Number(a)},b=function(a){return a=a.replace(/[^\d]/g,""),a=a.substr(a.length-10,a.length)},d=function(a,b){for(var d={},e=null,f=0,g=a.length;g>f;f++){if(e=c(b).attr(a[f].name),!e&&"required"in a[f])return null;e&&(d[a[f].name.replace(/dsta-(\w*\d{1}_)?/,"")]=a[f].parse?a[f].parse(e):e)}return d},e=[{name:"dsta-matter"},{name:"dsta-insurance",parse:a}],f={point:[{}]};f=c.extend(f,d(e,this));for(var g=0;10>g;g++){var h="dsta-point"+g+"_",i=d([{name:h+"address",required:!0},{name:h+"client_order_id"},{name:h+"taking",parse:a},{name:h+"weight",parse:a},{name:h+"phone",parse:b},{name:h+"contact_person"},{name:h+"required_time"},{name:h+"required_time_start"}],this);if(!i)break;f.point[g]=i}return f},w=function(a){var b={matter:null,insurance:0,point:[]};return a.each(function(a,d){var e=v.call(d);b.matter||(b.matter=e.matter),e.insurance&&(b.insurance+=e.insurance),"point"in e&&e.point.length&&(b.point.length&&e.point[0].address==b.point[0].address&&("weight"in e.point[0]&&(b.point[0].weight+=e.point[0].weight),e.point.shift()),c.merge(b.point,e.point))}),b},x=function(a){var b=/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/,c="";a.matter||(c+="Не задан параметр matter.\n");for(var d=0,e=a.point.length;e>d;d++)a.point[d].address||(c+="Не задан параметр point["+d+"].address.\n"),a.point[d].phone&&10===a.point[d].phone.length||(c+="Параметр point["+d+"].phone должен состоять из 10 цифр.\n"),b.test(a.point[d].required_time_start)||(c+="Параметр point["+d+"].required_time_start должен быть в формате YYYY-MM-DD HH:MM:SS.\n"),b.test(a.point[d].required_time)||(c+="Параметр point["+d+"].required_time должен быть в формате YYYY-MM-DD HH:MM:SS.\n"),a.point[d].weight||(c+="Не задан параметр point["+d+"].weight.\n");if(c)throw c},y=function(a,b){a=a||!1,c(this).removeClass(),c(this).addClass("DostavistaButton"),a&&(c(this).addClass("DostavistaButton_"+a),c.inArray(a,["sending","sent","error"])>-1&&c(this).addClass("DostavistaButton_disabled")),c(this).removeAttr("title"),b&&c(this).attr("title",b)},z=function(a,b){a=a||!1,c(this).removeClass(),c(this).addClass("DostavistaComboSubmit"),a&&(c(this).addClass("DostavistaComboSubmit_"+a),c.inArray(a,["sending","sent","error"])>-1&&c(this).addClass("DostavistaButton_disabled")),c(this).removeAttr("title"),b&&c(this).attr("title",b)},A=function(){return!(c(this).hasClass("DostavistaButton_disabled")||c(this).hasClass("DostavistaButton_sent"))},B=function(){return c(this).hasClass("DostavistaButton_error")};c(b).on("click",".DostavistaButton",s),c(b).on("click",".DostavistaCombo .DostavistaComboSubmit",t),c(b).on("click",".DostavistaCombo .DostavistaComboCheckbox",function(){var a=c(this).closest(".DostavistaCombo").find(".DostavistaComboSubmit");z.call(a)}),a.DostavistaApi={setApiUrl:n,setClient:o,setCallback:r,setTestOnBeta:p,setDebug:q}}(window,document,jQuery);