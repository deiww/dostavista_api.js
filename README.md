# Javascript-клиент для API dostavista.ru

**Задача библиотеки:** облегчить интеграцию интернет-магазинов со службой доставки Dostavista.ru.

JS-клиент предназначен для подключения к админке интернет-магазина, работает поверх XMLHttpRequest и предоставляет простой способ отправлять заказы в службу доставки.

## Правила работы

1. **Скачать последнюю версию библиотеки и подключить** в конец кода админки магазина после всех остальных скриптов и перед закрывающим тегом `</body>`.

	```html
	...
	<script src="js/dostavista_api.min.js"></script>
	</body>
	```

2. **Вставить тег `<span class="DSTA_button"></span>`** в тех местах, где вы хотите видеть кнопки «в Достависту». По-умолчанию, каждая кнопка будет отвечать за отправку данных одного заказа.

3. **Добавить dsta-аттрибуты, описывающие каждый заказ.** Для каждого тега `.DSTA_button` в разметке на момент инициализации Javascript должны содержаться все необходимые параметры.

	```html
	<span class="DSTA_button"
		...
		dsta-matter="Видеорегистратор" <!-- что везём -->
		dsta-insurance="15000" <!-- страховая сумма от 0 до 15000 в рублях -->
		...

		></span>
	```

	**Полный список всех атрибутов**

	| Атрибут | Тип и ограничения | Значение |
	|---------|-------------------|----------|
	| `dsta-matter` | Строка | Что везём, например «диктофон» или «видеорегистратор» |
	| `dsta-insurance` | Целое число от 0 до 15000 | Сумма страховки в рублях |
	| `dsta-point0_address` 
	| `dsta-point0_time_start` | YYYY-MM-DD HH:MM:SS | Время прибытия на точку (от) * обязательно |
	| `dsta-point0_time` | YYYY-MM-DD HH:MM:SS | Время прибытия на точку (до) * обязательно |
	| `dsta-point0_contact` | Строка | Имя контактного лица на точке забора |
	| `dsta-point0_phone` | 10 цифр без знака + и международного кода | Телефон контактного лица на точке забора |
	| `dsta-point0_weight` | ?Целое число? | Вес на точке | 
	| `dsta-point0_taking` | Целое число | Стоимость на точке: сумма,  которую должен взять курьер на точке |
	| `dsta-point0_client_order_id` | Строка | Номер заказа в магазине, используется для уведомлений на точках |


4. **Зарегистрировать общие для всего магазина параметры: `client_id` и `token`** для однозначной идентификации. Метод `register` не делает XHR-запросов, а просто сохраняет общие параметры на будущее.

	```html
	<script>
		DSTA_Client.register({
			client_id: 1234,
			token: 'xxxx'
		});
	</script>
	```

6. **Определить общую глобальную функцию-callback, которая будет вызываться после отправки данных заказа.**

	```html
	<script>
		DSTA_success = function(status, data) {
			if (!status) {
				alert(data.error_code + "\n" + data.error_message);
				return;
			}
			
			MyShop_save({
				order_id: data.order_id, // ID заказа в системе Dostavista.ru
				delivery_cost: data.payment // приблизительная стоимость доставки.
			});
		};
	</script>
	```

	Если `status === true`, значит заказ попал в Достависту, и можно сохранять результат у себя на сервере. В примере выше это делает функция `MyShop_save()`, но вы можете использовать любую другую.


	** Параметры коллбэка **

	| Название | Тип | Описание |
	|----------|-----|----------|
	| `status` | Boolean | Результат отправки. `false` значит, что произошла ошибка |
	| `data` | Object | Хэш с описанием результата. Отличается, в зависимости от `status` |
	| `data.error_message` | Строка | Сообщение об ошибке |
	| `data.error_code` | Массив | Массив с кодами ошибок |
	| `data.order_id` | Целое число | Внутренний номер заказа в системе Dostavista.ru | 
	| `data.payment` | Целое число | Приблизительная стоимость доставки |



## Описание API
[https://docs.google.com/a/oleggromov.com/document/d/1-yjBzfkI9Zb44kkQB_rMcq5pNeLThyD6YbvXR9wl7IY/](https://docs.google.com/a/oleggromov.com/document/d/1-yjBzfkI9Zb44kkQB_rMcq5pNeLThyD6YbvXR9wl7IY/)

## Вопросы

1. В каком часовом поясе указывается время? Не будет ли ошибок с конвертацией? Можно попробовать перейти на [ISO-8061](http://ru.wikipedia.org/wiki/ISO_8601) с обязательным указанием часового пояса.
2. Как тестировать API? Упомянутые в гуглодоке способы не удалось заставить работать.


## TODO 

1. Отправка множества точек одним вызовом
2. Запихнуть весь код в [песочницу](https://github.com/a-ignatov-parc/requirejs-sandbox)
3. Нарисовать брендированные кнопки и найти способ интегрировать их в скрипт.