<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Test dostavista API</title>

        <link rel="stylesheet" href="dostavista_api.css">
        <link rel="stylesheet" href="index.css">
    </head>
    <body>
        <!-- <span class="DostavistaButton"></span> -->

        <h1>Dostavista.js</h1>
        <p><a href="https://github.com/dostavista/dostavista_api.js">Github</a></p>
        <p>Данный плагин позволяет формировать и отправлять в сервис Dostavista заказы на доставку.</p>
        <p>Параметры заказа прописываются в dsta-атрибуты элементов.</p>
        <p>Возможны два основных варианта использования:</p>
        <p>1) все параметры заказа указаны в атрибутах кнопки</p>
        <p>2) параметры заказов указаны в атрибутах чекбоксов</p>
        <p>Ниже описываются эти два варианта. Обратите анимание, что для работы плагина необходимо наличие библиотеки jquery.</p>

        <h2>Вариант 1. Параметры заказа указываются в атрибутах кнопки</h2>
        <p>Для использования плагина нужно подключить скрипт dostavista_api.js и файл стилей dostavista_api.css и создать кнопку с классом <i>DostavistaButton</i> и следующими атрибутами:</p>
        <table class="parameters-definition">
            <thead>
                <tr>
                    <th>Атрибут</th>
                    <th>Обязательный</th>
                    <th>Тип данных</th>
                    <th>Описание</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="param">dsta-matter</td>
                    <td>Да</td>
                    <td>Строка, до 300 символов</td>
                    <td>Содержимое посылки</td>
                </tr>
                <tr>
                    <td class="param">dsta-insurance</td>
                    <td>Нет</td>
                    <td>Целое число</td>
                    <td>Сумма страховки</td>
                </tr>
                <tr>
                    <td class="param">dsta-point0_address</td>
                    <td>Да</td>
                    <td>Строка, до 300 символов</td>
                    <td>Адрес точки</td>
                </tr>
                <tr>
                    <td class="param">dsta-point0_required_time_start</td>
                    <td>Да</td>
                    <td>Время в формате ГГГГ-ММ-ДД ЧЧ:ММ:СС</td>
                    <td>Начало интервала времени посещения этой точки курьером.</td>
                </tr>
                <tr>
                    <td class="param">dsta-point0_required_time</td>
                    <td>Да</td>
                    <td>Время в формате ГГГГ-ММ-ДД ЧЧ:ММ:СС</td>
                    <td>Окончание интервала времени посещения этой точки курьером. Курьер должен прибыть на точку до этого времени.</td>
                </tr>
                <tr>
                    <td class="param">dsta-point0_contact_person</td>
                    <td>Нет</td>
                    <td>Строка, до 300 символов</td>
                    <td>Имя контактного лица на точке</td>
                </tr>
                <tr>
                    <td class="param">dsta-point0_phone</td>
                    <td>Да</td>
                    <td>Номер телефона, 10 последних цифр (без начальной 8 или 7)</td>
                    <td>Телефон контактного лица на точке</td>
                </tr>
                <tr>
                    <td class="param">dsta-point0_weight</td>
                    <td>Нет</td>
                    <td>Целое число</td>
                    <td>Вес отправления</td>
                </tr>
                <tr>
                    <td class="param">dsta-point0_client_order_id</td>
                    <td>Нет</td>
                    <td>Строка, до 100 символов</td>
                    <td>Внутренний номер заказа (по вашей нумерации).</td>
                </tr>
                <tr>
                    <td class="param">dsta-point0_taking</td>
                    <td>Нет</td>
                    <td>Целое число</td>
                    <td>Сумма выручки на точке. Если курьер должен забрать на точке оплату, укажите здесь ее сумму.</td>
                </tr>
            </tbody>
        </table>
        <p>Каждый заказ может иметь до 10 точек. Для задания номера точки используется цифра после dsta-point (от 0 до 9). Атрибуты, начинающиеся с dsta-point0_, описывают первую точку, dsta-point1_ - вторую, dsta-point2_ - третью и так далее.</p>
        <h3>Пример</h3>
        <div id="singleDemo">
            <span class="DostavistaButton"
                  dsta-matter="Проверочная доставка"
                  dsta-insurance="13000"
                  dsta-point0_address="ул. Новокосинская улица, 13"
                  dsta-point0_required_time_start="2013-12-30 18:00:00"
                  dsta-point0_required_time="2013-12-30 20:00:00"
                  dsta-point0_contact_person="Контактное лицо магазина"
                  dsta-point0_phone="+7 (923) 000-00-00"
                  dsta-point0_weight="4"
                  dsta-point0_client_order_id="9812"
                  dsta-point1_address="улица Солянка, 1/2 "
                  dsta-point1_required_time_start="2014-02-15 18:00:00"
                  dsta-point1_required_time="2014-02-15 20:00:00"
                  dsta-point1_contact_person="Олег"
                  dsta-point1_phone="+7 (915) 123-03-00"
                  dsta-point1_weight="4"
                  dsta-point1_taking="4500"></span>
        </div>
        <h3>Код примера</h3>
        <textarea cols="80" rows="36" readonly="readonly" class="demo-code" id="singleDemoCode"></textarea>

        <h2>Вариант 2. Параметры заказа указываются в атрибутах чекбоксов</h2>
        <p>Этот вариант использования годится, если вам нужно сформировать одну доставку из нескольких заказов.
            Для начала нужно создать контейнер - div или другой элемент с классом <i>DostavistaCombo</i>.
            Внутри этого контейнера нужно разместить чекбоксы с классом <i>DostavistaComboCheckbox</i>.
            Каждый чекбокс должен содержать dsta-атрибуты, описывающие ваш внутренний заказ (аналогично атрибутам кнопки в предыдущем примере).
            Также внутри контейнера нужно разместить кнопку с классом <i>DostavistaComboSubmit</i>.
            При нажатии на нее плагин соберет и отправит в Достависту заказ на доставку из всех отмеченных чекбоксов.
            Неотмеченные чекбоксы игнорируются.</p>
        <p>Первая точка (точка забора товара) будут сгруппированы. Это значит, что если вы отметили три заказа, и на них всех первая точка совпадает, то она будет добавлена в заказ только один раз (в качестве первой точки).</p>
        <p>После получения ответа от сервера об успешном создании заказа будет выполнен вызов пользовательского колбэка _YOUR_CALLBACK_, определенного вызовом DostavistaApi.setCallback('onSendSuccess', _YOUR_CALLBACK_), а кнопка изменит свой вид. Все отмеченные чекбоксы станут в этом случае недоступны.</p>
        <p>Если отметить другой чекбокс, кнопка отправки заказа снова станет доступна.</p>
        <h3>Пример</h3>
        <div id="comboDemo">
            <div class="DostavistaCombo">
                <ol>
                    <li>
                        <label>
                            <input type="checkbox" class="DostavistaComboCheckbox"
                                   dsta-matter="Проверочная доставка с несколькими точками"
                                   dsta-insurance="13000"

                                   dsta-point0_address="ул. Новокосинская улица, 13"
                                   dsta-point0_required_time_start="2013-12-30 18:00:00"
                                   dsta-point0_required_time="2013-12-30 20:00:00"
                                   dsta-point0_contact_person="Контактное лицо магазина"
                                   dsta-point0_phone="+7 (923) 000-00-00"
                                   dsta-point0_weight="4"

                                   dsta-point1_address="Покровка, 13"
                                   dsta-point1_required_time_start="2014-02-15 18:00:00"
                                   dsta-point1_required_time="2014-02-15 20:00:00"
                                   dsta-point1_contact_person="Олег"
                                   dsta-point1_phone="+7 (915) 123-03-00"
                                   dsta-point1_weight="4"
                                   dsta-point1_taking="4500"
                                   dsta-point1_client_order_id="1"
                                   />
                            1 заказ
                        </label>
                    </li>
                    <li>
                        <label>
                            <input type="checkbox" class="DostavistaComboCheckbox"
                                   dsta-matter="Проверочная доставка с несколькими точками"
                                   dsta-insurance="13000"

                                   dsta-point0_address="ул. Новокосинская улица, 13"
                                   dsta-point0_required_time_start="2013-12-30 18:00:00"
                                   dsta-point0_required_time="2013-12-30 20:00:00"
                                   dsta-point0_contact_person="Контактное лицо магазина"
                                   dsta-point0_phone="+7 (923) 000-00-00"
                                   dsta-point0_weight="4"

                                   dsta-point1_address="Осенний, 1"
                                   dsta-point1_required_time_start="2014-02-15 18:00:00"
                                   dsta-point1_required_time="2014-02-15 20:00:00"
                                   dsta-point1_contact_person="Олег"
                                   dsta-point1_phone="+7 (915) 123-03-00"
                                   dsta-point1_weight="4"
                                   dsta-point1_taking="4500"
                                   dsta-point1_client_order_id="2"
                                   />
                            2 заказ
                        </label>
                    </li>
                    <li>
                        <label>
                            <input type="checkbox" class="DostavistaComboCheckbox"
                                   dsta-matter="Проверочная доставка с несколькими точками"
                                   dsta-insurance="13000"

                                   dsta-point0_address="ул. Внезапная, 1"
                                   dsta-point0_required_time_start="2013-12-30 18:00:00"
                                   dsta-point0_required_time="2013-12-30 20:00:00"
                                   dsta-point0_contact_person="Контактное лицо магазина на третьем заказе. Точка забора отличается от первого заказа."
                                   dsta-point0_phone="+7 (923) 000-00-00"
                                   dsta-point0_weight="4"

                                   dsta-point1_address="бул Алмирала Ушакова, 15"
                                   dsta-point1_required_time_start="2014-02-15 18:00:00"
                                   dsta-point1_required_time="2014-02-15 20:00:00"
                                   dsta-point1_contact_person="Клиент на третьем заказе"
                                   dsta-point1_phone="+7 (915) 123-03-00"
                                   dsta-point1_weight="4"
                                   dsta-point1_taking="4500"
                                   dsta-point1_client_order_id="3"
                                   />
                            3 заказ
                        </label>
                    </li>
                    <li>
                        <label>
                            <input type="checkbox" class="DostavistaComboCheckbox"
                                   dsta-matter="Проверочная доставка с несколькими точками"
                                   dsta-insurance="130000"

                                   dsta-point0_address=""
                                   dsta-point0_required_time_start="2013-12-30 18:00:00"
                                   dsta-point0_required_time="2013-12-30 20:00:00"
                                   dsta-point0_contact_person="Контактное лицо магазина на третьем заказе. Точка забора отличается от первого заказа."
                                   dsta-point0_phone="WRONG-PHONE"
                                   dsta-point0_weight="4"

                                   dsta-point1_address="бул Алмирала Ушакова, 15"
                                   dsta-point1_required_time_start="2014-02-15 18:00:00"
                                   dsta-point1_required_time="2014-02-15 20:00:00"
                                   dsta-point1_contact_person="Клиент на третьем заказе"
                                   dsta-point1_phone="+7 (915) 123-03-00"
                                   dsta-point1_weight="4"
                                   dsta-point1_taking="4500"
                                   dsta-point1_client_order_id="3"
                                   />
                            4 заказ с ошибкой в данных
                        </label>
                    </li>
                </ol>
                <button class="DostavistaComboSubmit"></button>
            </div>
        </div>
        <h3>Код примера</h3>
        <textarea cols="80" rows="40" readonly="readonly" class="demo-code" id="comboDemoCode"></textarea>

        <h2>Ответ сервиса</h2>
        <p>Как видно из вышеприведенных примеров, ответ API передается в callback-функции, задаваемые методом <tt>DostavistaApi.setCallback(callbackName, myFunction)</tt>.</p>
<p>Существует 2 вида callback'ов: onSendSuccess и onSendError.</p>
<h3>onSendSuccess</h3>
<p>Этот колбэк вызывается при успешном создании заказа. Функция принимает 2 параметра - <tt>result</tt> и <tt>nodes</tt>.</p>
<p><tt>result</tt> - это объект, содержащий свойства <tt>order_id</tt> - номер заказа в Достависте и <tt>payment</tt> - примерная стоимость доставки</p>
<p><tt>nodes</tt> - это список элементов DOM, из которых брались данные для формирования заказа. В варианте интеграции с одной кнопкой этот список будет содержать только эту кнопку,
а для комбо-заказов - отмеченные чекбоксы.</p>
<h3>onError</h3>
<p>Этот колбэк вызывается, если при формировании заказа произошла ошибка (невалидные данные). Функция принимает 1 параметр <tt>error</tt> - текст сообщения об ошибке.</p>
<h3>onSendError</h3>
<p>Этот колбэк вызывается, если при отправке заказа в Достависту произошла ошибка. Функция принимает 3 параметра - <tt>jqxhr</tt> - объект типа jQuery XMLHttpRequest, <tt>text</tt> - ответ сервера и <tt>error</tt> - текст ошибки.</p>

<div id="scriptDemo">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="dostavista_api.js"></script>
    <script>
        DostavistaApi.setClient({
            client_id: 13,
            token: '6347E382B2E06D03C456DDCD8A8D63AE'
        });
        DostavistaApi.setCallback('onSendSuccess', function (result, button) {
            console.log(button);
            console.log(result);
        });
        DostavistaApi.setCallback('onSendError', function (jqxhr, text, error) {
            console.log(text);
            console.log(error);
        });
        DostavistaApi.setCallback('onError', function (error, nodes) {
            alert(error);
            console.log(nodes);
        });
    </script>
    <script>
        $('#singleDemoCode').text($('#singleDemo').html());
        $('#comboDemoCode').text($('#comboDemo').html());
    </script>
</div>
</body>
</html>